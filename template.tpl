___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Reelevant Server Side Tracking",
  "categories": [
    "PERSONALIZATION"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "Reelevant",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Track user\u0027s behavior from server side and use it in Reelevant.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "eventConfiguration",
    "displayName": "Event configuration",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "SELECT",
        "name": "eventName",
        "displayName": "Event",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "product_page",
            "displayValue": "Product page view"
          },
          {
            "value": "add_cart",
            "displayValue": "Add item to cart"
          },
          {
            "value": "purchase",
            "displayValue": "Purchase items"
          },
          {
            "value": "purchase_references",
            "displayValue": "Purchase items (with references)"
          },
          {
            "value": "category_view",
            "displayValue": "Category page view"
          },
          {
            "value": "brand_view",
            "displayValue": "Brand page view"
          },
          {
            "value": "product_hover",
            "displayValue": "Product hovered"
          },
          {
            "value": "custom",
            "displayValue": "Custom event"
          }
        ],
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "eventInfo",
        "displayName": "",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "LABEL",
            "name": "productPageInfo",
            "displayName": "This event can be used to track viewed product pages",
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "product_page",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "LABEL",
            "name": "productHoverInfo",
            "displayName": "This event can be used to track viewed product that are hovered",
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "product_hover",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "LABEL",
            "name": "addCartInfo",
            "displayName": "This event can be used to track add to cart actions",
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "add_cart",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "LABEL",
            "name": "purchaseInfo",
            "displayName": "This event can be used to track purchases of one or multiple items (with product ids)",
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "purchase",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "LABEL",
            "name": "purchaseReferencesInfo",
            "displayName": "This event can be used to track purchases of one or multiple items (with reference ids)",
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "purchase_references",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "LABEL",
            "name": "categoryViewInfo",
            "displayName": "This event can be used to track viewed category pages",
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "category_view",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "LABEL",
            "name": "brandViewInfo",
            "displayName": "This event can be used to track viewed brand pages",
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "brand_view",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "LABEL",
            "name": "customInfo",
            "displayName": "You can trigger any custom event that will be available in Reelevant",
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "custom",
                "type": "EQUALS"
              }
            ]
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "eventConfig",
        "displayName": "Configuration",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "datasourceId",
            "displayName": "Datasource\u0027s ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "companyId",
            "displayName": "Company\u0027s ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "brandNames",
            "displayName": "Brand name",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "brand_view",
                "type": "EQUALS"
              }
            ],
            "textAsList": true,
            "valueValidators": [
              {
                "type": "TABLE_ROW_COUNT",
                "args": [
                  1
                ]
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "categoryNames",
            "displayName": "Category name",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "category_view",
                "type": "EQUALS"
              }
            ],
            "textAsList": true,
            "valueValidators": [
              {
                "type": "TABLE_ROW_COUNT",
                "args": [
                  1
                ]
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "productIds",
            "displayName": "Product\u0027s ids",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "product_page",
                "type": "EQUALS"
              },
              {
                "paramName": "eventName",
                "paramValue": "add_cart",
                "type": "EQUALS"
              },
              {
                "paramName": "eventName",
                "paramValue": "purchase",
                "type": "EQUALS"
              },
              {
                "paramName": "eventName",
                "paramValue": "product_hover",
                "type": "EQUALS"
              }
            ],
            "textAsList": true,
            "valueValidators": [
              {
                "type": "TABLE_ROW_COUNT",
                "args": [
                  1
                ]
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "referenceIds",
            "displayName": "Product\u0027s reference ids",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "purchase_references",
                "type": "EQUALS"
              }
            ],
            "textAsList": true,
            "valueValidators": [
              {
                "type": "TABLE_ROW_COUNT",
                "args": [
                  1
                ]
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "totalPrice",
            "displayName": "Total price",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "purchase",
                "type": "EQUALS"
              }
            ],
            "textAsList": false,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "userId",
            "displayName": "User\u0027s id",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "customEventName",
            "displayName": "Event\u0027s name",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "custom",
                "type": "EQUALS"
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "transId",
            "displayName": "Transaction ID",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "purchase",
                "type": "EQUALS"
              },
              {
                "paramName": "eventName",
                "paramValue": "purchase_references",
                "type": "EQUALS"
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "PARAM_TABLE",
            "name": "labels",
            "displayName": "Additionals labels",
            "paramTableColumns": [
              {
                "param": {
                  "type": "TEXT",
                  "name": "name",
                  "displayName": "Name",
                  "simpleValueType": true
                },
                "isUnique": true
              },
              {
                "param": {
                  "type": "TEXT",
                  "name": "value",
                  "displayName": "Value",
                  "simpleValueType": true
                },
                "isUnique": false
              }
            ]
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

// Server-side specific requirements
const getAllEventData = require('getAllEventData');
const sendHttpRequest = require('sendHttpRequest');
const getRequestHeader = require('getRequestHeader');
const setCookie = require('setCookie');
const getCookieValues = require('getCookieValues');
const generateRandom = require('generateRandom');
const logToConsole = require('logToConsole');
const JSON = require('JSON');

// Helper function to generate random string
const generateRandomId = () => {
  const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ123456789';
  let result = '';
  for (let i = 0; i < 32; i++) {
    result += chars[generateRandom(0, chars.length - 1)];
  }
  return result;
};

const parseIds = (value) => {
  if (value.concat) return value;
  return [value];
};

const eventData = getAllEventData();
logToConsole('Debug:', { event: eventData, data: data });

// Get or generate client ID
const tmpId = getCookieValues('rlvt_tmpId')[0] || generateRandomId();

// Set client ID cookie if not exists
if (!getCookieValues('rlvt_tmpId')[0]) {
  setCookie('rlvt_tmpId', tmpId, {
    domain: 'auto',
    path: '/',
    secure: true,
    httpOnly: true,
    'max-age': 15768000 // 3 months
  });
}

// Transform the event data based on event type
let payload = {
  name: data.customEventName || data.eventName,
  url: eventData.page_location,
  data: {},
  clientId: data.userId,
  key: data.companyId,
  tmpId: tmpId,
  v: 1,
  eventId: generateRandomId()
};

// Add event specific data
switch(data.eventName) {
  case 'product_page':
    payload.data.ids = parseIds(data.productIds);
    break;
  case 'purchase':
    payload.data.ids = parseIds(data.productIds);
    payload.data.value = data.totalPrice;
    payload.data.transId = data.transId;
    break;
  case 'category_view':
    payload.data.ids = parseIds(data.categoryNames);
    break;
  case 'brand_view':
    payload.data.ids = parseIds(data.brandNames);
    break;
  case 'add_cart':
    payload.data.ids = parseIds(data.productIds);
    break;
  case 'purchase_references':
    payload.data.ids = parseIds(data.referenceIds);
    payload.data.value = data.totalPrice;
    payload.data.transId = data.transId;
    break;
  case 'identify':
    payload.userId = data.userId;
    break;
  case 'custom':
    payload.data.eventName = data.customEventName;
    break;
}

// Add labels if present
if (data.labels) {
  payload.data = data.labels.reduce((acc, label) => {
    acc[label.name] = label.value;
    return acc;
  }, payload.data);
}

// Send to Reelevant API using POST
sendHttpRequest('https://collector.reelevant.com/collect/' + data.datasourceId + '/rlvt', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'User-Agent': getRequestHeader('User-Agent')
  },
  timeout: 2000
 }, JSON.stringify(payload))
.then((response) => {
  if (response.statusCode >= 200 && response.statusCode < 300) {
    data.gtmOnSuccess();
  } else {
    data.gtmOnFailure();
  }
})
.catch(() => data.gtmOnFailure());


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "User-Agent"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "rlvt_tmpId"
              },
              {
                "type": 1,
                "string": "rlvt_clientId"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rlvt_tmpId"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rlvt_clientId"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://collector.reelevant.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Add to queue before boot and set global labels
  code: |-
    // Call page view before boot
    runCode({
      eventName: 'page_view'
    });
    assertApi('setInWindow').wasCalledWith('reel', { queue: [] }, false);
    assertApi('callInWindow').wasCalledWith('reel.queue.push', ['page_view', {}]);

    // Mock queue and inject script
    mock('copyFromWindow', [['page_view', {}]]);
    mock('injectScript', function (_, onSuccess) {
      return onSuccess();
    });

    // Call boot
    runCode({
      eventName: 'boot',
      datasourceId: 'foo',
      companyId: 'bar',
      globalLabels: [{ name: 'labelName', value: 'labelValue' }]
    });

    // Verify that the boot finished successfully
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('setInWindow').wasCalledWith('reel', {
      datasourceId: 'foo',
      companyId: 'bar',
      queue: [['page_view', {}]],
      globalLabels: {
        labelName: 'labelValue'
      }
    }, true);


___NOTES___

Created on 22/12/2020 à 16:37:00


